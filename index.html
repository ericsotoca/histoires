
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Conte de Poche - Lecture Vocale</title>
    <style>
        /* --- CSS Inspir√© et Simplifi√© --- */
        :root {
            --bg-color: #f4f7f9;
            --text-color: #212529;
            --primary-color: #0056b3; /* Bleu histoire */
            --secondary-color: #5a9a00; /* Vert musique/play */
            --accent-color: #ffc107; /* Jaune attention/voix */
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --input-bg: #ffffff;
            --button-text: #ffffff;
            --link-color: var(--primary-color);
            --disabled-color: #adb5bd;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545; /* Rouge stop */
            --success-color: #28a745;

            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;

            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;

            --border-radius: 4px;
            --shadow: 0 2px 5px var(--shadow-color);
            --focus-outline-color: color-mix(in srgb, var(--primary-color) 50%, transparent);
            --focus-outline-width: 3px;
        }

        /* Th√®me Sombre Optionnel */
        body.dark-mode {
            --bg-color: #212529; --text-color: #e9ecef; --primary-color: #4dabf7; --secondary-color: #94d82d;
            --accent-color: #ffd43b; --card-bg: #343a40; --border-color: #495057; --input-bg: #495057;
            --button-text: #212529; --link-color: var(--primary-color); --disabled-color: #6c757d; --shadow-color: rgba(0, 0, 0, 0.3);
            --danger-color: #f57782; --success-color: #7ee2a1; --focus-outline-color: color-mix(in srgb, var(--accent-color) 70%, transparent);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: var(--font-size-base); scroll-behavior: smooth; }
        body { font-family: var(--font-main); background-color: var(--bg-color); color: var(--text-color); line-height: var(--line-height-base); transition: background-color 0.3s ease, color 0.3s ease; padding: var(--spacing-l); }
        #app { max-width: 800px; margin: 0 auto; background-color: var(--card-bg); padding: var(--spacing-l); border-radius: var(--border-radius); box-shadow: var(--shadow); }

        *:focus-visible { outline: var(--focus-outline-width) solid var(--focus-outline-color); outline-offset: 2px; box-shadow: 0 0 0 var(--focus-outline-width) var(--focus-outline-color); border-radius: var(--border-radius); }
        button:focus { outline: none; }

        h1, h2 { color: var(--primary-color); margin-bottom: var(--spacing-m); text-align: center;}
        h2 { margin-top: var(--spacing-l); }

        /* Listes */
        ul { list-style: none; padding: 0; margin-bottom: var(--spacing-l); max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: var(--spacing-s);}
        li { background-color: color-mix(in srgb, var(--bg-color) 50%, transparent); margin-bottom: var(--spacing-s); padding: var(--spacing-m); border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; border: 1px solid transparent;}
        li:hover { background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); box-shadow: 0 1px 3px var(--shadow-color); }
        li.selected { background-color: color-mix(in srgb, var(--primary-color) 50%, transparent); border-color: var(--primary-color); font-weight: bold; }
        li.playing { background-color: var(--secondary-color); color: var(--button-text); font-weight: bold; border-color: var(--secondary-color); }

        /* Contr√¥les */
        .controls-section { margin-top: var(--spacing-l); padding-top: var(--spacing-l); border-top: 1px solid var(--border-color); }
        .controls-section h2 { margin-bottom: var(--spacing-l); }
        .controls-row { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: var(--spacing-m); margin-bottom: var(--spacing-l);}
        .controls-row label { font-weight: 500; margin-right: var(--spacing-s); }
        .controls-row select { padding: var(--spacing-s); border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: var(--input-bg); color: var(--text-color); min-width: 150px; }
        .tts-status { font-size: 0.9em; font-style: italic; color: var(--disabled-color); margin-left: var(--spacing-s); }

        .volume-control { display: flex; align-items: center; justify-content: center; gap: var(--spacing-s); margin-bottom: var(--spacing-m); max-width: 350px; margin-left: auto; margin-right: auto;}
        .volume-control label { margin-bottom: 0; flex-shrink: 0; }
        .volume-control input[type="range"] { width: auto; flex-grow: 1; margin-bottom: 0; }
        .volume-control output { font-weight: bold; color: var(--primary-color); min-width: 30px; text-align: right;}

        /* Boutons */
        button, .button { display: inline-flex; align-items: center; justify-content: center; background-color: var(--primary-color); color: var(--button-text); border: none; padding: var(--spacing-m) var(--spacing-l); border-radius: var(--border-radius); font-size: inherit; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease; text-align: center; text-decoration: none; margin: var(--spacing-s); gap: var(--spacing-s); }
        button:hover, .button:hover { background-color: color-mix(in srgb, var(--primary-color) 85%, black); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        button:active, .button:active { transform: translateY(1px); }
        button:disabled, .button:disabled { background-color: var(--disabled-color); color: color-mix(in srgb, var(--text-color) 70%, var(--disabled-color)); cursor: not-allowed; box-shadow: none; transform: none; }
        .button-play { background-color: var(--secondary-color); }
        .button-play:hover { background-color: color-mix(in srgb, var(--secondary-color) 85%, black); }
        .button-stop { background-color: var(--danger-color); }
        .button-stop:hover { background-color: color-mix(in srgb, var(--danger-color) 80%, black); }

        /* √âtat */
        #status { margin-top: var(--spacing-m); padding: var(--spacing-m); background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); text-align: center; font-style: italic; color: var(--primary-color); min-height: 50px; display: flex; align-items: center; justify-content: center;}
        #status.playing { color: var(--secondary-color); font-weight: bold; }

        .hidden { display: none !important; }
        #story-text-display { margin-top: var(--spacing-l); padding: var(--spacing-m); background-color: color-mix(in srgb, var(--bg-color) 80%, transparent); border: 1px solid var(--border-color); border-radius: var(--border-radius); max-height: 200px; overflow-y: auto; line-height: 1.7; }
        #story-text-display h3 { color: var(--primary-color); margin-bottom: var(--spacing-m); text-align: center; }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: var(--spacing-m); }
            #app { padding: var(--spacing-m); }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.2em; }
            ul { max-height: 200px; }
            li { padding: var(--spacing-s) var(--spacing-m); }
            button, .button { padding: var(--spacing-s) var(--spacing-m); font-size: 0.95em; }
            .controls-row { flex-direction: column; align-items: stretch; text-align: center; }
            .controls-row label { margin-bottom: var(--spacing-s); }
            .controls-row select { width: 100%; }
            .volume-control { flex-direction: column; }
            .volume-control label { margin-bottom: var(--spacing-s); }
            .volume-control input[type="range"] { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Mon Conte de Poche - Lecture Vocale üó£Ô∏è</h1>

        <section id="story-section">
            <h2>Choisissez une histoire</h2>
            <ul id="story-list">
                <li id="loading-stories">Chargement des histoires...</li>
            </ul>
        </section>

         <section id="story-text-display" class="hidden">
             <h3>Texte de l'histoire s√©lectionn√©e</h3>
             <div id="story-content"></div>
         </section>


        <section class="controls-section">
            <h2>Options de Lecture</h2>

            <div class="controls-row">
                 <label for="voice-select">Voix de lecture :</label>
                 <select id="voice-select">
                     <option value="">Voix par d√©faut</option>
                     <!-- Les voix fran√ßaises seront ajout√©es ici -->
                 </select>
                 <span id="tts-status" class="tts-status"></span>
            </div>

            <div class="controls-row">
                 <label for="music-select">Musique d'ambiance :</label>
                 <select id="music-select">
                     <option value="">Aucune</option>
                     <!-- Les musiques seront ajout√©es ici par JavaScript -->
                 </select>
            </div>

             <div class="volume-control">
                 <label for="music-volume">Volume Musique:</label>
                 <input type="range" id="music-volume" min="0" max="1" step="0.05" value="0.2"> <!-- Volume musique par d√©faut plus bas -->
                 <output id="music-volume-output">20%</output>
             </div>

        </section>

        <section class="controls-section">
             <h2>Contr√¥les de lecture</h2>
            <div id="status">S√©lectionnez une histoire pour commencer.</div>

            <div class="main-controls" style="text-align: center;">
                <button id="play-pause-btn" class="button-play" disabled>‚ñ∂Ô∏è Lire</button>
                <!-- Pause/Resume pour TTS est moins fiable, on utilise Lire/Arr√™ter -->
                <!-- <button id="pause-resume-btn" disabled>‚è∏Ô∏è Pause</button> -->
                <button id="stop-btn" class="button-stop" disabled>‚èπÔ∏è Arr√™ter</button>
            </div>
        </section>
    </div>

    <!-- √âl√©ment Audio pour la musique de fond uniquement -->
    <audio id="music-audio" loop></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Conte de Poche (TTS) App Initializing...");

            // --- Configuration ---
            const stories = [
                { id: 'chapitre1', name: "1. La R√©v√©lation sous le Baobab", text: `
LE PARCOURS DU CHAMPION D'AWAL√â

## 1. La R√©v√©lation sous le Baobab

Le soleil de l'apr√®s-midi filtre √† travers les branches massives du baobab centenaire, cr√©ant des motifs dansants sur le sol ocre de la place du village. Vous vous approchez, attir√© par les rires et les exclamations qui √©manent d'un petit groupe d'anciens. La poussi√®re rouge s'√©l√®ve en fins nuages autour de vos sandales √† chaque pas.

Deux hommes sont assis face √† face sur des tabourets sculpt√©s, pench√©s au-dessus d'un objet en bois qui capte toute leur attention. Entre eux, un plateau allong√©, creus√© de douze alv√©oles dispos√©es en deux rang√©es. Dans chaque creux, des graines brillantes refl√®tent la lumi√®re dor√©e du soleil couchant.

L'air est charg√© d'une multitude d'odeurs : la terre chauff√©e par le soleil, les fleurs de baobab au parfum √©pic√© et l√©g√®rement sucr√©, et les effluves de cuisine qui s'√©chappent des maisons voisines. Une brise l√©g√®re agite les feuilles au-dessus de votre t√™te, cr√©ant un bruissement apaisant qui accompagne le cliquetis des graines sur le plateau.

Vous vous arr√™tez √† quelques pas, fascin√© par la concentration des joueurs. Leurs doigts agiles saisissent les graines, les distribuent avec une pr√©cision qui t√©moigne d'ann√©es de pratique. Chaque mouvement est suivi d'un silence, puis d'exclamations ou de hochements de t√™te approbateurs de la part des spectateurs.

Un vieil homme au visage burin√© par les ann√©es remarque votre int√©r√™t. Il vous fait signe d'approcher avec un sourire bienveillant qui creuse davantage les rides autour de ses yeux.

"Tu n'as jamais vu d'awal√©, jeune homme?" demande-t-il d'une voix rauque mais chaleureuse.

Vous secouez la t√™te, incapable de d√©tacher votre regard du plateau.

"Viens," dit-il en se levant avec une agilit√© surprenante pour son √¢ge. "Je vais t'apprendre."

Il vous guide vers un banc de pierre ti√®de et vous fait asseoir. L'un des joueurs se l√®ve, vous c√©dant sa place avec un clin d'≈ìil complice. Le vieil homme place le plateau entre vous deux.

Le bois du plateau est doux sous vos doigts, poli par des ann√©es d'utilisation. Les alv√©oles sont profondes, parfaitement lisses. Les graines - vous apprendrez plus tard qu'il s'agit de graines d'iroko - sont fra√Æches au toucher malgr√© la chaleur ambiante, leur surface lisse provoquant une sensation agr√©able contre votre paume.

"L'awal√© est plus qu'un jeu," explique le vieil homme tandis qu'il dispose les graines dans les alv√©oles. "C'est notre histoire, notre sagesse, notre mani√®re de comprendre le monde."

Une femme s'approche, portant un plateau avec deux verres de th√© √† la menthe. La vapeur parfum√©e s'√©l√®ve en volutes d√©licates. Lorsque vous prenez une gorg√©e, le go√ªt sucr√© et rafra√Æchissant du th√© se r√©pand sur votre langue, contrastant avec l'amertume l√©g√®re des feuilles de menthe.

Pendant les heures qui suivent, vous apprenez les r√®gles fondamentales. La sensation des graines roulant entre vos doigts devient rapidement famili√®re. Le son qu'elles produisent en tombant dans les alv√©oles vous hypnotise presque. Votre premier mouvement est maladroit, quelques graines d√©bordent du plateau et s'enfoncent dans la poussi√®re.

"Patience," murmure le vieil homme avec un sourire. "Les graines sont comme des pens√©es, il faut les semer avec soin."

√Ä mesure que le soleil descend vers l'horizon, colorant le ciel de teintes orang√©es et pourpres, quelque chose d'ind√©finissable s'√©veille en vous. Chaque mouvement, chaque d√©cision semble r√©sonner avec une partie oubli√©e de votre √™tre. Lorsque vous r√©ussissez votre premi√®re capture, la joie qui vous envahit est inexplicable, disproportionn√©e pour un simple jeu.

Les spectateurs applaudissent, leurs mains cr√©ant un rythme qui semble faire √©cho aux battements acc√©l√©r√©s de votre c≈ìur. L'odeur de la nuit qui approche - plus fra√Æche, plus humide - se m√™le aux parfums de la journ√©e.

Quand finalement vous vous levez, vos jambes sont engourdies d'√™tre rest√© assis si longtemps, mais votre esprit est √©trangement alerte, comme √©veill√© d'un long sommeil.

"Reviens demain," dit le vieil homme en r√©cup√©rant les graines une √† une, les comptant avec pr√©cision. "Il y a encore beaucoup √† apprendre."

Sur le chemin du retour, le cr√©pitement des insectes nocturnes accompagne vos pas. Vous sentez encore la texture des graines contre vos doigts, comme une empreinte. Cette nuit-l√†, vous r√™vez de graines qui tombent en cascade, dessinant des motifs complexes qui racontent des histoires que vous comprenez sans mots.

Ce jour-l√†, sous le baobab centenaire, quelque chose a chang√© en vous. Une graine diff√©rente a √©t√© plant√©e, une graine qui germerait pour devenir une passion d√©vorante, et plus tard, une destin√©e.
                ` },
                { id: 'chapitre2', name: "2. L'Entra√Ænement au Cr√©puscule", text: `
## 2. L'Entra√Ænement au Cr√©puscule

Le parc municipal s'habille doucement des teintes orang√©es du cr√©puscule. Les ombres s'allongent sur les all√©es de graviers, tandis que les derniers rayons du soleil filtrent √† travers les branches des acacias, cr√©ant un jeu de lumi√®re dor√© sur les tables en b√©ton. C'est votre rituel quotidien depuis trois mois : apr√®s le travail, vous venez ici, l√† o√π le temps semble ralentir.

Vous inspirez profond√©ment. L'air du soir est charg√© d'ar√¥mes - l'herbe fra√Æchement coup√©e, la terre humide des parterres de fleurs, et les effluves √©pic√©s qui s'√©chappent des fen√™tres ouvertes des maisons bordant le parc. Des plats mijotent dans les cuisines, m√©langes de cumin, de coriandre et d'ail qui vous rappellent que vous n'avez pas encore d√Æn√©.

Mais la faim peut attendre. Une silhouette famili√®re est d√©j√† install√©e √† votre table habituelle, celle qui se trouve sous le plus grand des acacias. Malgr√© ses soixante-dix ans, Monsieur Ibrahim arrive toujours avant vous. Son plateau d'awal√© est d√©j√† dispos√©, les graines parfaitement align√©es dans leurs alv√©oles. Six graines dans chacune des douze cavit√©s, soixante-douze au total. Vous avez appris √† les compter machinalement, une habitude que votre mentor vous a inculqu√©e.

"Le jour o√π tu perdras une graine, tu perdras aussi ton √©quilibre," r√©p√®te-t-il souvent.

Ses mains reposent sur ses genoux, paumes vers le ciel, dans cette posture de patience qui lui est propre. √Ä votre approche, il l√®ve les yeux. Son regard per√ßant semble toujours vous analyser, m√™me quand ses l√®vres s'√©tirent en un sourire chaleureux.

"Tu as l'air fatigu√© aujourd'hui," remarque-t-il alors que vous prenez place en face de lui.

Le banc en b√©ton est froid sous vos jambes, contraste saisissant avec la chaleur qui persiste dans l'air. Vous posez votre sacoche √† c√¥t√© de vous, sortant le carnet o√π vous notez chaque partie, chaque le√ßon.

"Journ√©e difficile au bureau," r√©pondez-vous en frottant vos yeux. "Mais je suis pr√™t."

Ibrahim hoche la t√™te et vous tend une tasse de caf√© qu'il a apport√© dans un thermos. L'ar√¥me riche et l√©g√®rement amer vous enveloppe, r√©veillant instantan√©ment vos sens. La premi√®re gorg√©e est br√ªlante, presque douloureuse, mais la saveur intense agit comme un stimulant imm√©diat. L'amertume reste sur votre langue tandis que la chaleur descend dans votre gorge.

"Aujourd'hui, nous allons travailler sur ta vision p√©riph√©rique," annonce Ibrahim. "Un grand joueur d'awal√© ne regarde jamais seulement l'alv√©ole qu'il vise, mais l'ensemble du plateau."

Vous acquiescez, reconnaissant la sagesse de ses paroles. Trop souvent, vous vous concentrez sur une strat√©gie sp√©cifique, oubliant de consid√©rer l'ensemble des possibilit√©s.

La premi√®re partie commence sans autre pr√©ambule. Vos doigts, d'abord raides apr√®s une journ√©e √† taper sur un clavier, retrouvent progressivement leur souplesse. Les graines sont fra√Æches contre votre peau, leur surface lisse offrant un contraste apaisant avec la rugosit√© de la table en b√©ton.

Le cliquetis des graines tombant dans les alv√©oles cr√©e une musique rythmique qui se m√™le aux chants des derniers oiseaux. Au loin, des enfants rient encore sur l'aire de jeux, leurs voix port√©es par la brise l√©g√®re qui fait fr√©mir les feuilles au-dessus de vos t√™tes.

Ibrahim joue avec une pr√©cision m√©canique, ses mouvements fluides et √©conomes. Vous observez ses mains - couvertes de taches de vieillesse mais incroyablement agiles. Chaque graine qu'il saisit semble reconna√Ætre son toucher, ob√©issant √† une volont√© qui transcende le simple geste.

"Regarde l'ensemble," murmure-t-il alors que vous vous appr√™tez √† faire un mouvement. "Sens le plateau comme une extension de tes mains."

Vous fermez bri√®vement les yeux, tentant d'int√©grer son conseil. Lorsque vous les rouvrez, quelque chose a chang√©. Le plateau n'est plus seulement une s√©rie d'alv√©oles individuelles, mais un tout coh√©rent, un syst√®me d'√©quilibres et de d√©s√©quilibres.

Votre prochain mouvement surprend Ibrahim. Ses sourcils se soul√®vent l√©g√®rement - la plus grande marque d'approbation qu'il s'autorise g√©n√©ralement. Vous venez d'ex√©cuter une s√©quence que vous n'aviez jamais tent√©e auparavant, distribuant les graines de mani√®re √† pr√©parer une capture trois coups plus tard.

"Tu commences √† voir," dit-il simplement.

La partie se poursuit alors que le cr√©puscule c√®de la place √† la nuit. Les lampadaires du parc s'allument un √† un, entourant votre table d'un halo jaun√¢tre. L'air se rafra√Æchit, apportant avec lui l'humidit√© de la nuit. La sensation du vent sur votre peau nue vous fait frissonner l√©g√®rement, mais votre concentration reste intacte.

Ibrahim finit par remporter la partie, comme toujours. Mais cette fois, l'√©cart est plus faible. Lorsqu'il compte les graines captur√©es, son expression trahit une satisfaction qui d√©passe le simple plaisir de la victoire.

"Tu apprends vite," dit-il en rangeant m√©thodiquement les graines. "Bient√¥t, tu seras pr√™t pour ton premier tournoi."

L'id√©e vous fait avaler de travers la derni√®re gorg√©e de caf√©, maintenant ti√®de. La comp√©tition n'avait jamais √©t√© votre objectif. L'awal√© √©tait devenu une passion, un refuge, pas une ar√®ne.

"Je ne suis pas s√ªr d'√™tre pr√™t pour √ßa," r√©pondez-vous, essuyant quelques gouttes de caf√© sur votre menton.

Ibrahim referme son plateau avec un claquement sec qui r√©sonne dans l'air nocturne.

"On n'est jamais pr√™t," dit-il avec un sourire √©nigmatique. "On plonge, et on apprend √† nager en se noyant."

Sur le chemin du retour, les lampadaires projettent votre ombre d√©mesur√©ment allong√©e sur le trottoir. Le go√ªt du caf√© persiste dans votre bouche, se m√™lant maintenant √† celui, plus subtil, de l'appr√©hension. Mais sous cette nervosit√©, une excitation nouvelle pulse en vous.

Cette nuit-l√†, allong√© dans votre lit, vous entendez encore le son des graines tombant dans les alv√©oles. Vos doigts bougent inconsciemment, reproduisant des mouvements, explorant des strat√©gies. Votre esprit, incapable de trouver le sommeil, projette des plateaux d'awal√© sur le plafond de votre chambre.

Le tournoi. La comp√©tition. Une nouvelle √©tape dans votre voyage. L'id√©e qui vous effrayait quelques heures plus t√¥t semble maintenant in√©vitable, comme si le chemin avait toujours √©t√© trac√© ainsi.
                ` },
                 { id: 'chapitre3', name: "3. Premier Tournoi Local", text: `
## 3. Premier Tournoi Local

Le centre communautaire est m√©connaissable ce samedi matin. Habituellement vide et calme, il bourdonne aujourd'hui d'une activit√© fr√©n√©tique. Des tables ont √©t√© align√©es dans la grande salle, chacune accueillant un plateau d'awal√© et deux joueurs. L'√©clairage fluorescent, cru et impitoyable, donne √† la sc√®ne une qualit√© presque surr√©aliste.

Vous vous tenez √† l'entr√©e, votre sac contenant votre plateau personnel serr√© contre votre poitrine comme un bouclier. L'odeur caract√©ristique du centre vous assaille - un m√©lange de produits d'entretien industriels, de vieux livres de la biblioth√®que adjacente, et maintenant, de transpiration humaine. Un fond olfactif auquel s'ajoute l'ar√¥me du caf√© bon march√© servi dans un coin.

"Premi√®re fois ?"

La voix vous fait sursauter. Une femme d'une cinquantaine d'ann√©es vous observe avec un sourire bienveillant. Son badge indique "Organisatrice".

Vous acquiescez, la gorge soudain s√®che. Les mots semblent coinc√©s quelque part entre votre cerveau et votre bouche.

"Ne t'inqui√®te pas," poursuit-elle en vous guidant vers une table d'inscription. "Tout le monde a commenc√© quelque part."

Le processus d'enregistrement est rapide, m√©canique. Vous signez des formulaires, recevez un num√©ro, √©coutez distraitement les explications sur le syst√®me de tournoi. Votre attention est ailleurs, capt√©e par l'atmosph√®re √©lectrique qui r√®gne dans la salle.

Des joueurs de tous √¢ges sont pr√©sents. Certains, comme vous, semblent nerveux, tripotant maladroitement leurs plateaux ou les graines. D'autres affichent la confiance tranquille des v√©t√©rans, discutant strat√©gie avec animation, leurs mains mimant des mouvements complexes dans l'air.

On vous assigne une table, la num√©ro sept. Le plateau fourni par l'organisation est standardis√©, diff√©rent du v√¥tre. Les alv√©oles sont parfaitement identiques, le bois plus clair, moins patin√©. Les graines sont uniformes, l√©g√®rement plus petites que celles auxquelles vous √™tes habitu√©. Lorsque vous les touchez, elles semblent plus l√©g√®res, presque insubstantielles compar√©es √† vos graines d'iroko polies par des ann√©es d'utilisation.

Votre premier adversaire arrive - un adolescent √† l'air studieux, lunettes √† monture √©paisse et t-shirt orn√© d'un logo de jeu vid√©o. Il se pr√©sente comme Thomas, √©tudiant et joueur d'awal√© depuis deux ans. Sa poign√©e de main est ferme, confiante.

"Bonne chance," dit-il avec un sourire qui n'atteint pas tout √† fait ses yeux.

Une cloche retentit, signalant le d√©but du tournoi. Le brouhaha des conversations diminue instantan√©ment, remplac√© par le cliquetis caract√©ristique des graines sur le bois. Votre bouche est si s√®che que vous pouvez √† peine avaler. Un go√ªt m√©tallique, celui de l'anxi√©t√©, s'installe sur votre langue.

Thomas, en tant que joueur plus exp√©riment√© en comp√©tition, commence. Ses doigts agiles saisissent les graines de l'alv√©ole de son choix et les distribue avec une pr√©cision m√©canique. Le son des graines tombant une √† une dans les creux r√©sonne √©trangement fort √† vos oreilles.

C'est votre tour. Votre main tremble l√©g√®rement lorsque vous l'approchez du plateau. Les graines semblent glisser entre vos doigts, rebelles, diff√©rentes de celles avec lesquelles vous vous entra√Ænez quotidiennement.

√Ä quelques tables de l√†, quelqu'un croque bruyamment dans une pomme, le son de la morsure tranchant √† travers votre concentration. L'odeur des arachides grill√©es que mange un spectateur flotte jusqu'√† vous, √©trangement r√©confortante dans cet environnement stressant.

Les premiers tours sont maladroits. Vous faites des erreurs de d√©butant, oubliant de compter correctement, ratant des occasions √©videntes de capture. Thomas, bien que silencieux, ne manque pas de capitaliser sur chacune de vos erreurs.

Le temps passe, marqu√© par le tic-tac implacable de l'horloge murale. Les chaises en plastique grincent sous le poids des joueurs qui se penchent, se redressent, changent de position. Le sol en linoleum amplifie chaque mouvement, chaque pas.

Puis, quelque chose change. Peut-√™tre est-ce l'adaptation √† l'environnement, ou le souvenir des entra√Ænements avec Ibrahim qui refait surface. Vos mouvements deviennent plus assur√©s. Les graines, d'abord √©trang√®res, retrouvent leur familiarit√© sous vos doigts. Votre vision s'√©largit, englobant tout le plateau.

"Int√©ressant," murmure Thomas apr√®s que vous ayez ex√©cut√© une capture particuli√®rement √©l√©gante.

Le match se poursuit, √©quilibr√© maintenant. La salle autour de vous semble s'estomper, les bruits s'att√©nuent. Il ne reste plus que le plateau, les graines, et le rythme hypnotique du jeu.

Finalement, apr√®s ce qui semble √™tre √† la fois une √©ternit√© et un instant, le match se termine. Thomas a gagn√©, mais de justesse. Lorsque vous comptez les graines captur√©es, l'√©cart n'est que de trois points.

"Bien jou√© pour un premier tournoi," dit Thomas en vous tendant la main √† nouveau. Cette fois, son sourire semble plus authentique. "Tu as un style int√©ressant. Tr√®s intuitif."

Ces mots r√©sonnent en vous, effa√ßant partiellement la d√©ception de la d√©faite. Vous remerciez Thomas et vous pr√©parez pour votre prochain match.

Le tournoi se d√©roule sur toute la journ√©e. Match apr√®s match, vous alternez victoires et d√©faites. Chaque partie est un apprentissage. Certains adversaires sont techniques, calculateurs, d'autres plus instinctifs, impr√©visibles. Vous absorbez, adaptez, √©voluez.

Pendant la pause d√©jeuner, assis seul avec un sandwich fade de la caf√©t√©ria, vous remarquez Ibrahim qui vous observe depuis l'entr√©e. Il ne s'approche pas, mais son hochement de t√™te approbateur vaut tous les encouragements.

√Ä la fin de la journ√©e, vous n'avez pas remport√© le tournoi. Vous n'√™tes m√™me pas dans les dix premiers. Mais quelque chose a chang√©. La nervosit√© du matin s'est transform√©e en une d√©termination tranquille. Les graines standardis√©es du tournoi, d'abord √©trang√®res, sont devenues des extensions de vos doigts.

Lorsque vous quittez le centre communautaire, le soleil commence √† se coucher, peignant le ciel de teintes orang√©es. L'air frais du soir est revigorant apr√®s des heures pass√©es dans l'atmosph√®re confin√©e de la salle.

Sur le chemin du retour, vous percevez encore le cliquetis des graines, comme un √©cho. Votre premier tournoi est termin√©, mais quelque chose vous dit que ce n'est que le d√©but d'un long voyage.
                ` },
                 { id: 'chapitre4', name: "4. La Ma√Ætrise de la Technique 'Krou'", text: `
## 4. La Ma√Ætrise de la Technique "Krou"

La pluie tambourine contre les fen√™tres de la petite salle d'√©tude, cr√©ant une toile sonore apaisante qui contraste avec l'intense concentration qui r√®gne √† l'int√©rieur. L'odeur des vieux livres empil√©s sur les √©tag√®res se m√™le √† celle, plus subtile, du bois cir√© du plateau d'awal√© pos√© devant vous. Une lampe de bureau projette un cercle de lumi√®re chaude sur la table, isolant le plateau du reste de la pi√®ce plong√©e dans une semi-p√©nombre.

Face √† vous se tient Monsieur Konat√©, ancien champion d'awal√© et maintenant professeur respect√© de ce jeu mill√©naire. Originaire de C√¥te d'Ivoire, il a apport√© avec lui non seulement sa ma√Ætrise technique, mais aussi une compr√©hension profonde de la philosophie qui sous-tend chaque mouvement.

"La technique 'Krou' n'est pas seulement une strat√©gie," explique-t-il de sa voix basse et m√©lodieuse qui porte l'accent chantant de son pays natal. "C'est une fa√ßon de penser, de voir plusieurs mouvements √† l'avance, comme un joueur d'√©checs, mais avec la fluidit√© d'un danseur."

Il se l√®ve et se dirige vers le tableau blanc fix√© au mur. Le marqueur couine l√©g√®rement lorsqu'il commence √† dessiner des diagrammes, repr√©sentant diff√©rentes configurations du plateau. Ses mains, grandes et expressives, tracent des fl√®ches, des cercles, construisant un langage visuel complexe.

"Regarde," dit-il en tapotant le tableau. "La beaut√© du 'Krou' r√©side dans sa simplicit√© apparente qui cache une complexit√© profonde."

Vous observez attentivement, tentant d'absorber chaque d√©tail. Votre carnet est ouvert devant vous, les pages d√©j√† couvertes de notes et de sch√©mas des sessions pr√©c√©dentes. L'encre bleue de votre stylo s'√©tale l√©g√®rement sur le papier √† cause de l'humidit√© ambiante.

Sur la petite table √† c√¥t√© de vous repose une tasse de th√© au gingembre que Monsieur Konat√© a pr√©par√© avant la le√ßon. Le parfum √©pic√© s'√©l√®ve en volutes, stimulant vos sens. Vous prenez une gorg√©e - le liquide est encore chaud, la saveur piquante du gingembre se r√©pand sur votre langue, suivie par une douceur subtile qui contraste agr√©ablement.

Monsieur Konat√© revient s'asseoir face √† vous. Ses yeux, derri√®re des lunettes √† monture fine, scrutent votre visage √† la recherche de signes de compr√©hension.

"Maintenant, nous allons mettre la th√©orie en pratique," annonce-t-il en r√©arrangeant les graines sur le plateau. "Je vais cr√©er une situation, et tu vas tenter d'appliquer la technique."

Ses doigts dansent sur le plateau, disposant les graines dans une configuration sp√©cifique. Le son des graines tombant dans les alv√©oles en bois cr√©e une m√©lodie famili√®re, presque m√©ditative.

"Voil√†," dit-il en reculant ses mains. "Que ferais-tu maintenant?"

Vous vous penchez sur le plateau, analysant la situation. Les graines sont dispos√©es de mani√®re asym√©trique - certaines alv√©oles contiennent jusqu'√† huit graines, d'autres seulement une ou deux. La distribution n'est pas al√©atoire, vous le savez, mais con√ßue pour tester votre compr√©hension.

Vos doigts effleurent les graines sans les saisir, sentant leur texture famili√®re, l√©g√®rement rugueuse mais polie par des ann√©es de manipulation. Vous fermez bri√®vement les yeux, visualisant les mouvements possibles, leurs cons√©quences, les r√©actions probables.

Dehors, le tonnerre gronde au loin. La pluie s'intensifie, frappant les vitres avec plus d'insistance. Le contraste entre la temp√™te ext√©rieure et le calme studieux de la salle accentue √©trangement votre concentration.

Finalement, vous choisissez une alv√©ole - la troisi√®me de votre rang√©e, contenant quatre graines. Vos doigts les saisissent d'un mouvement fluide, puis les distribuent une √† une. La derni√®re graine tombe dans une alv√©ole contenant deux graines, ce qui vous permet de capturer le contenu de l'alv√©ole oppos√©e.

Monsieur Konat√© hoche la t√™te, mais son expression reste neutre. "Continue," murmure-t-il.

La s√©quence se poursuit. Chaque mouvement en pr√©pare un autre, chaque capture en anticipe une suivante. C'est comme construire un pont tout en le traversant - chaque pierre doit √™tre plac√©e pr√©cis√©ment pour que la structure tienne.

Apr√®s plusieurs minutes de jeu intense, vous terminez une s√©quence particuli√®rement complexe. Cinq captures cons√©cutives, un encha√Ænement que vous n'auriez jamais cru possible il y a encore quelques semaines.

Un sourire rare illumine le visage de Monsieur Konat√©. "Tu l'as fait," dit-il simplement. "C'√©tait une ex√©cution parfaite de la technique 'Krou'."

Une vague de satisfaction vous submerge, presque physique dans son intensit√©. La sensation est comparable √† celle d'un coureur atteignant la ligne d'arriv√©e apr√®s un marathon - √©puisement et exaltation m√™l√©s.

"Ce n'√©tait pas juste chance?" demandez-vous, encore incr√©dule face √† ce que vous venez d'accomplir.

Monsieur Konat√© secoue la t√™te. "La chance n'existe pas dans l'awal√©. Seulement la vision et la pr√©paration." Il commence √† r√©arranger les graines. "Essayons √† nouveau, avec une configuration diff√©rente."

Les heures passent, marqu√©es uniquement par le changement d'intensit√© de la pluie et les gorg√©es occasionnelles de th√©, maintenant froid. Votre concentration ne faiblit pas. Chaque nouvelle configuration est un puzzle √† r√©soudre, chaque mouvement une pi√®ce √† placer correctement.

Parfois, vous √©chouez, perdant le fil de votre strat√©gie ou manquant une opportunit√© cach√©e. Dans ces moments, Monsieur Konat√© ne montre jamais de d√©ception, seulement une patience infinie. "Recommence," dit-il simplement. "Observe plus largement."

Vers la fin de la session, la pluie s'est calm√©e, se transformant en un bruissement doux contre les fen√™tres. L'air de la pi√®ce s'est impr√©gn√© d'une odeur de terre mouill√©e qui s'infiltre par les interstices des fen√™tres anciennes.

"Une derni√®re configuration," annonce Monsieur Konat√©. Ses mouvements sont plus lents maintenant, trahissant une l√©g√®re fatigue.

Cette fois, la disposition est d'une complexit√© intimidante. Vos yeux parcourent le plateau, cherchant un point d'entr√©e, une faille dans ce qui semble √™tre un labyrinthe imp√©n√©trable.

Vous respirez profond√©ment, laissant l'air emplir vos poumons. L'odeur des livres, du bois, du th√©, de la pluie - tout se m√™le en une symphonie olfactive qui, √©trangement, clarifie votre esprit.

Votre main se pose sur l'alv√©ole que vous avez choisie. Les graines sont chaudes sous vos doigts, comme vivantes. Le premier mouvement initie une cascade, une r√©action en cha√Æne soigneusement orchestr√©e.

Lorsque vous terminez, neuf graines ont √©t√© captur√©es en une seule s√©quence. C'est votre record personnel.

Le silence qui suit est presque sacr√©, rompu uniquement par le tic-tac discret de l'horloge murale. Monsieur Konat√© vous regarde avec une expression nouvelle - non plus celle d'un professeur √©valuant un √©l√®ve, mais celle d'un ma√Ætre reconnaissant un pair potentiel.

"Tu as ma√Ætris√© le 'Krou'," dit-il finalement. "Mais ce n'est qu'un d√©but. Il existe d'autres techniques, d'autres niveaux de compr√©hension."

Vous acquiescez, √† la fois √©puis√© et √©nergis√© par cette r√©v√©lation. La sensation d'accomplissement est indescriptible, comme une chaleur qui se r√©pand dans votre poitrine, irradiant jusqu'au bout de vos doigts.

"Je suis pr√™t √† apprendre," r√©pondez-vous.

Monsieur Konat√© sourit tout en commen√ßant √† ranger les graines dans leur bo√Æte en bois sculpt√©. Le son des graines s'entrechoquant doucement ponctue ses paroles:

"Apprendre, oui, toujours. Mais maintenant, il est peut-√™tre temps de commencer √† enseigner aussi."

Cette suggestion vous surprend. "Enseigner? Mais je viens √† peine de..."

"L'enseignement est le meilleur apprentissage," l'interrompt-il doucement. "Quand tu expliques √† un autre, tu comprends mieux toi-m√™me."

Dehors, le ciel s'√©claircit progressivement. Un rayon de soleil perce √† travers les nuages, illuminant bri√®vement la pi√®ce d'une lumi√®re dor√©e. Ce moment de clart√© semble souligner les paroles de Monsieur Konat√©, leur donnant un poids suppl√©mentaire.

Vous quittez la salle d'√©tude avec un sentiment de transformation. Quelque chose a chang√© en vous aujourd'hui - une compr√©hension plus profonde, une connexion plus intime avec le jeu qui est devenu bien plus qu'un simple passe-temps.

La technique "Krou" n'est plus un myst√®re, mais un outil dans votre arsenal, une cl√© qui ouvre de nouvelles portes dans votre voyage √† travers le monde fascinant de l'awal√©.
                ` },
                 { id: 'chapitre5', name: "5. Le Duel Contre le Champion R√©gional (Partie 1)", text: `
## 5. Le Duel Contre le Champion R√©gional

L'amphith√©√¢tre municipal, habituellement r√©serv√© aux conf√©rences et spectacles, a √©t√© transform√© pour l'occasion. Les si√®ges, dispos√©s en demi-cercle, sont tous occup√©s. Des centaines de personnes, venues de toute la r√©gion, murmurent avec anticipation. L'excitation est palpable, vibrant dans l'air comme un courant √©lectrique invisible.

Vous √™tes assis sur sc√®ne, √† une table sp√©cialement install√©e sous les projecteurs. La chaleur des lumi√®res est intense, faisant perler de fines gouttes de sueur sur votre front. En face de vous, impassible, se tient Yao "Le Calculateur", champion r√©gional depuis trois ann√©es cons√©cutives. Son visage est une √©nigme, ses yeux sombres ne trahissant aucune √©motion.

Le silence s'installe progressivement dans la salle tandis que l'arbitre annonce le d√©but du match final. Un micro amplifie le son de sa voix, qui r√©sonne dans tout l'amphith√©√¢tre. Puis, il ne reste plus que le bruit feutr√© des graines sur le plateau, amplifi√© lui aussi par des micros discrets plac√©s pr√®s de la table.

Chaque cliquetis semble r√©sonner dans votre poitrine. Votre c≈ìur bat √† un rythme effr√©n√©, un contraste saisissant avec le calme apparent de votre adversaire. L'odeur de la poussi√®re de sc√®ne, m√™l√©e √† celle du parfum discret de Yao, flotte dans l'air immobile.

Vous essayez de vous concentrer, de vous rappeler les enseignements d'Ibrahim et de Konat√©. La vision p√©riph√©rique, la technique "Krou", la patience. Mais l'atmosph√®re est √©crasante. Le poids des regards des spectateurs semble peser sur vos √©paules.

Le d√©but du match est tendu. Chaque joueur prend son temps, analysant le plateau, anticipant les mouvements futurs. Yao joue avec une pr√©cision redoutable, ses doigts effil√©s se d√©pla√ßant avec une rapidit√© et une √©conomie de mouvement qui vous d√©concertent. Chaque graine qu'il distribue semble tomber exactement l√† o√π il l'avait pr√©vu.

Vous r√©sistez, appliquant les strat√©gies apprises, tentant de ne pas vous laisser submerger par la r√©putation et la pr√©sence de votre adversaire. Vous parvenez √† r√©aliser quelques captures, for√ßant Yao √† adapter sa d√©fense.

La partie s'√©tire, chaque coup √©tant suivi d'un silence intense dans la salle. Les spectateurs retiennent leur souffle, leurs yeux riv√©s sur le plateau comme s'il s'agissait du centre de l'univers.

(Fin de la partie fournie pour le chapitre 5)
                ` },
                // Ajouter les chapitres 6 √† 10 ici quand ils seront fournis
                // Exemple de placeholder si le texte n'est pas encore l√†:
                 { id: 'chapitre6', name: "6. L'Invitation Inattendue", text: `## 6. L'Invitation Inattendue \n\n (Texte du chapitre 6 √† ajouter)` },
                 { id: 'chapitre7', name: "7. Le Voyage vers l'Inconnu", text: `## 7. Le Voyage vers l'Inconnu \n\n (Texte du chapitre 7 √† ajouter)` },
                 { id: 'chapitre8', name: "8. La Rencontre des Ma√Ætres", text: `## 8. La Rencontre des Ma√Ætres \n\n (Texte du chapitre 8 √† ajouter)` },
                 { id: 'chapitre9', name: "9. La Finale Mondiale", text: `## 9. La Finale Mondiale \n\n (Texte du chapitre 9 √† ajouter)` },
                 { id: 'chapitre10', name: "10. Le Retour du Champion", text: `## 10. Le Retour du Champion \n\n (Texte du chapitre 10 √† ajouter)` },
            ];

            const backgroundMusic = [
                // IMPORTANT: Remplacez '#' par les URLs r√©elles de vos fichiers musicaux
                { id: 'musique1', name: "Ambiance Douce", url: "musics/douce.mp3" }, // Exemple
                { id: 'musique2', name: "For√™t Myst√©rieuse", url: "musics/foret.mp3" },
                { id: 'musique3', name: "Nuit √âtoil√©e", url: "musics/nuit.mp3" },
                { id: 'musique4', name: "Voyage Spatial Calme", url: "#" },
                { id: 'musique5', name: "Piano Relaxant", url: "#" },
            ];

            // --- R√©f√©rences DOM ---
            const storyListEl = document.getElementById('story-list');
            const storyTextDisplayEl = document.getElementById('story-text-display');
            const storyContentEl = document.getElementById('story-content');
            const musicSelectEl = document.getElementById('music-select');
            const voiceSelectEl = document.getElementById('voice-select');
            const ttsStatusEl = document.getElementById('tts-status');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const statusEl = document.getElementById('status');
            const musicAudio = document.getElementById('music-audio');
            const musicVolumeSlider = document.getElementById('music-volume');
            const musicVolumeOutput = document.getElementById('music-volume-output');

            // --- √âtat de l'application ---
            let currentStory = null;
            let currentMusic = null;
            let isPlaying = false; // Indique si TTS ou musique est en cours
            let isTTSReading = false; // Sp√©cifiquement pour l'√©tat de la lecture TTS
            let audioContextResumed = false;

            // --- MODULE: Synth√®se Vocale (TTS) ---
            const TTSManager = (() => {
                const synthesis = window.speechSynthesis;
                let voices = [];
                let isSupported = false;
                let currentUtterance = null;
                let preferredVoiceURI = null; // Pour stocker la s√©lection
                let isTTSReadingInternal = false; // Renomm√© pour clart√©

                function init() { // D√©claration de la fonction init
                    if ('speechSynthesis' in window) {
                        isSupported = true;
                        console.log("TTS support√©.");
                        // Essayer de peupler imm√©diatement, puis attendre l'√©v√©nement
                        populateVoiceList();
                        if (synthesis.onvoiceschanged !== undefined) {
                            synthesis.onvoiceschanged = populateVoiceList;
                        }
                        if(ttsStatusEl) ttsStatusEl.textContent = ''; // V√©rifier si l'√©l√©ment existe
                    } else {
                        console.warn("TTS non support√©.");
                         if(ttsStatusEl) ttsStatusEl.textContent = "(Lecture vocale non support√©e)";
                         if(voiceSelectEl) voiceSelectEl.disabled = true;
                         if(playPauseBtn) playPauseBtn.disabled = true;
                    }
                }

                 function populateVoiceList() {
                    if (!isSupported || !synthesis) return; // Ajouter v√©rification synthesis
                    try {
                        // Filtrer pour obtenir les voix fran√ßaises
                        voices = synthesis.getVoices().filter(v => v.lang.startsWith('fr'));
                        console.log("Voix FR trouv√©es:", voices.length);

                        if (!voiceSelectEl) return; // Sortir si l'√©l√©ment n'existe pas encore

                        const currentVal = voiceSelectEl.value;
                        voiceSelectEl.innerHTML = '<option value="">Voix syst√®me par d√©faut</option>';

                        voices.forEach(voice => {
                            const option = document.createElement('option');
                            option.value = voice.voiceURI;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            // Conserver la s√©lection si elle existe d√©j√† ou correspond √† la pr√©f√©r√©e
                            option.selected = (voice.voiceURI === currentVal && currentVal !== "") || voice.voiceURI === preferredVoiceURI;
                            voiceSelectEl.appendChild(option);
                        });

                         // Si une voix √©tait s√©lectionn√©e et existe toujours, la garder, sinon utiliser la pr√©f√©r√©e si elle existe
                         if (currentVal && voices.some(v => v.voiceURI === currentVal)) {
                              voiceSelectEl.value = currentVal;
                              preferredVoiceURI = currentVal; // Mettre √† jour la pr√©f√©r√©e
                         } else if (preferredVoiceURI && voices.some(v => v.voiceURI === preferredVoiceURI)) {
                              voiceSelectEl.value = preferredVoiceURI;
                         }


                        voiceSelectEl.disabled = (voices.length === 0);
                         if (ttsStatusEl) { // V√©rifier si ttsStatusEl existe
                            if (voices.length === 0 && isSupported) {
                                ttsStatusEl.textContent = "(Aucune voix FR trouv√©e)";
                            } else {
                                ttsStatusEl.textContent = '';
                            }
                         }

                    } catch (e) {
                        console.error("Erreur getVoices:", e);
                        if(ttsStatusEl) ttsStatusEl.textContent = "(Erreur chargement voix)";
                        if(voiceSelectEl) voiceSelectEl.disabled = true;
                    }
                }

                function speak(text, onEndCallback) {
                     if (!isSupported || !text) return false;
                     // Si d√©j√† en train de parler, annuler d'abord pour √©viter conflit
                     if (synthesis.speaking) {
                         console.warn("TTS Manager: Already speaking, cancelling previous utterance first.");
                         cancel(); // Arr√™te la pr√©c√©dente
                         // Ajouter un petit d√©lai avant de parler √† nouveau peut aider sur certains navigateurs
                         // setTimeout(() => speak(text, onEndCallback), 100);
                         // return true; // Indique qu'on a *essay√©* de lancer
                     }


                    currentUtterance = new SpeechSynthesisUtterance(text);
                    preferredVoiceURI = voiceSelectEl.value;
                    const selectedVoice = voices.find(v => v.voiceURI === preferredVoiceURI);

                    if (selectedVoice) {
                        currentUtterance.voice = selectedVoice;
                        console.log("Voix TTS s√©lectionn√©e:", selectedVoice.name);
                    } else {
                         let defaultFrVoice = voices.find(v => v.lang === 'fr-FR') || voices.find(v => v.lang.startsWith('fr'));
                         if (defaultFrVoice) {
                             currentUtterance.voice = defaultFrVoice;
                             console.log("Voix TTS FR par d√©faut utilis√©e:", defaultFrVoice.name);
                         } else { console.warn("Aucune voix FR trouv√©e, utilise d√©faut syst√®me."); }
                    }

                    currentUtterance.lang = 'fr-FR';
                    currentUtterance.pitch = 1;
                    currentUtterance.rate = 1;

                    currentUtterance.onstart = () => {
                        console.log("TTS: Lecture d√©marr√©e.");
                        isTTSReadingInternal = true;
                    };

                    currentUtterance.onend = () => {
                        console.log("TTS: Lecture termin√©e.");
                        isTTSReadingInternal = false;
                        currentUtterance = null;
                        if (typeof onEndCallback === 'function') {
                            onEndCallback();
                        }
                    };

                    currentUtterance.onerror = (e) => {
                         console.error('Erreur TTS:', e.error);
                         updateStatus(`Erreur lecture vocale: ${e.error}`);
                         isTTSReadingInternal = false;
                         currentUtterance = null;
                         if (typeof onEndCallback === 'function') {
                             onEndCallback(true);
                         }
                    };

                     try {
                        synthesis.speak(currentUtterance);
                        console.log("TTS: Demande de lecture envoy√©e.");
                        return true;
                    } catch (e) {
                        console.error("Erreur synthesis.speak:", e);
                        updateStatus("Impossible de d√©marrer la lecture vocale.");
                        isTTSReadingInternal = false;
                        currentUtterance = null;
                         if (typeof onEndCallback === 'function') {
                             onEndCallback(true);
                         }
                        return false;
                    }
                }

                function cancel() {
                    if (synthesis && (synthesis.speaking || synthesis.pending)) {
                        console.log("TTS: cancel() demand√©.");
                        isTTSReadingInternal = false; // Mettre √† jour l'√©tat AVANT d'annuler peut √©viter des conditions de course
                        synthesis.cancel();
                    }
                    // Assurer que l'√©tat est bien r√©initialis√© m√™me si cancel() est appel√© sans lecture en cours
                     isTTSReadingInternal = false;
                     currentUtterance = null;
                }

                function pause() { if(synthesis && synthesis.speaking) synthesis.pause(); }
                function resume() { if(synthesis && synthesis.paused) synthesis.resume(); }

                // Ne PAS appeler init() ici √† l'int√©rieur

                // Retourner l'objet avec les m√©thodes publiques, y compris init
                return {
                    init, // <<<---- AJOUT√â ICI
                    isSupported: () => isSupported,
                    populateVoiceList, // Exposer pour une mise √† jour manuelle si besoin
                    speak,
                    cancel,
                    pause,
                    resume,
                    isSpeaking: () => isTTSReadingInternal // Utiliser la variable interne renomm√©e
                };
            })();
            // --- Fin MODULE TTS ---
            // --- Fonctions ---

            // Initialisation de l'Audio Context sur interaction utilisateur
            function initAudioContextIfNeeded() {
                if (audioContextResumed || !TTSManager.isSupported()) return; // Pas besoin si d√©j√† fait ou si TTS non support√©

                const forceAudio = () => {
                     if (audioContextResumed) return;
                    // Pour Web Audio API (si on l'utilisait) et parfois n√©cessaire pour SpeechSynthesis
                    const tempContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (tempContext.state === 'suspended') {
                        tempContext.resume().then(() => {
                            console.log("AudioContext resumed on user interaction.");
                            audioContextResumed = true;
                            tempContext.close(); // Ferme le contexte temporaire
                             // Retirer les √©couteurs une fois l'action r√©ussie
                             document.body.removeEventListener('click', forceAudio, { capture: true });
                             document.body.removeEventListener('touchstart', forceAudio, { capture: true });
                             document.body.removeEventListener('keydown', forceAudio, { capture: true });
                        }).catch(e => console.error("Error resuming AudioContext:", e));
                    } else {
                        audioContextResumed = true;
                        console.log("AudioContext already active or not needed to resume.");
                        tempContext.close();
                        // Retirer les √©couteurs car l'audio est actif
                         document.body.removeEventListener('click', forceAudio, { capture: true });
                         document.body.removeEventListener('touchstart', forceAudio, { capture: true });
                         document.body.removeEventListener('keydown', forceAudio, { capture: true });
                    }
                     // Pour SpeechSynthesis, essayer de parler d'une espace vide peut aussi aider
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(' '));
                     window.speechSynthesis.cancel(); // Annuler imm√©diatement
                };

                 // Attacher les √©couteurs pour la premi√®re interaction
                 document.body.addEventListener('click', forceAudio, { once: true, capture: true });
                 document.body.addEventListener('touchstart', forceAudio, { once: true, capture: true });
                 document.body.addEventListener('keydown', forceAudio, { once: true, capture: true });
                 console.log("Audio interaction listeners attached.");
            }


            function populateStories() {
                storyListEl.innerHTML = '';
                if (!stories || stories.length === 0) {
                    storyListEl.innerHTML = '<li>Aucune histoire disponible.</li>';
                    return;
                }
                stories.forEach(story => {
                    const li = document.createElement('li');
                    li.textContent = story.name;
                    li.dataset.storyId = story.id;
                    // V√©rifier si le texte existe et n'est pas juste un placeholder
                    if (!story.text || story.text.includes("(Texte du chapitre")) {
                         li.style.opacity = "0.5";
                         li.title = "Texte non disponible";
                         li.style.cursor = "not-allowed";
                    } else {
                        li.addEventListener('click', () => selectStory(story));
                    }
                    storyListEl.appendChild(li);
                });
            }

             function formatStoryTextForDisplay(text) {
                // Simple formatage: remplace les titres markdown par des h4 et les nouvelles lignes par des <p>
                let html = text.trim()
                               .replace(/^## (.*)$/gm, '<h4>$1</h4>') // Titres h2 markdown -> h4 HTML
                               .replace(/\n\n+/g, '</p><p>')        // Doubles sauts de ligne -> paragraphes
                               .replace(/\n/g, '<br>');              // Sauts de ligne simples -> <br>
                return '<p>' + html + '</p>'; // Encapsuler dans un <p> initial
             }


            function populateMusic() {
                if (!backgroundMusic || backgroundMusic.length === 0) return;
                backgroundMusic.forEach(music => {
                    const option = document.createElement('option');
                    option.value = music.id;
                    option.textContent = music.name;
                    if (!music.url || music.url === "#") {
                        option.disabled = true;
                        option.textContent += " (indisponible)";
                    }
                    musicSelectEl.appendChild(option);
                });
            }

            function selectStory(storyData) {
                 if (!storyData || !storyData.text || storyData.text.includes("(Texte du chapitre")) return;

                console.log("Selecting story:", storyData.name);

                // Annuler la lecture en cours si une autre histoire est s√©lectionn√©e
                 if (TTSManager.isSpeaking() || isPlaying) {
                    stopPlayback();
                 }

                currentStory = storyData;

                // Met √† jour l'UI de la liste
                document.querySelectorAll('#story-list li').forEach(li => {
                    li.classList.remove('selected', 'playing');
                    if (li.dataset.storyId === storyData.id) {
                        li.classList.add('selected');
                    }
                });

                 // Affiche le texte de l'histoire s√©lectionn√©e
                 storyContentEl.innerHTML = formatStoryTextForDisplay(storyData.text);
                 storyTextDisplayEl.classList.remove('hidden');
                 storyTextDisplayEl.scrollTop = 0; // Remonte en haut

                updateStatus(`Pr√™t √† lire : ${storyData.name}`);
                playPauseBtn.disabled = false;
                stopBtn.disabled = false; // On peut arr√™ter m√™me avant de lire

                // On ne change pas la musique s√©lectionn√©e ici
            }

            function selectMusic() {
                const selectedId = musicSelectEl.value;
                const wasMusicPlaying = !musicAudio.paused;

                 // Arr√™ter la musique pr√©c√©dente proprement
                 musicAudio.pause();
                 musicAudio.src = ""; // Important pour arr√™ter compl√®tement le chargement/lecture

                if (!selectedId) {
                    console.log("Music selection: None");
                    currentMusic = null;
                } else {
                    currentMusic = backgroundMusic.find(music => music.id === selectedId);
                    if (currentMusic && currentMusic.url && currentMusic.url !== "#") {
                        console.log("Selecting music:", currentMusic.name);
                        musicAudio.src = currentMusic.url;
                        musicAudio.load();
                         // Si la lecture TTS √©tait en cours (ou l'√©tat global isPlaying), relancer la musique
                        if (isPlaying) {
                            musicAudio.play().catch(e => console.error("Error restarting music:", e));
                        }
                    } else {
                        console.log("Selected music not available or invalid.");
                        currentMusic = null;
                    }
                }
                // Mettre √† jour le volume au cas o√π
                setMusicVolume(musicVolumeSlider.value);
            }

             // Fonction appel√©e √† la fin de la lecture TTS ou sur erreur
             function handleTTSFinished(errorOccurred = false) {
                 console.log(`TTS finished. Error: ${errorOccurred}`);
                 isTTSReading = false; // Assurer que l'√©tat TTS est bien false

                 // Ne pas changer isPlaying ici, car la musique peut continuer
                 // Si on veut que tout s'arr√™te √† la fin du TTS:
                 if (isPlaying) { // V√©rifie si on √©tait activement en mode "lecture"
                     stopPlayback(); // Arr√™te tout, y compris la musique
                     if (!errorOccurred && currentStory) {
                        updateStatus(`Histoire "${currentStory.name}" termin√©e.`);
                        // Res√©lectionne visuellement
                        document.querySelector(`#story-list li[data-story-id="${currentStory.id}"]`)?.classList.add('selected');
                     }
                 } else {
                    // Si on n'√©tait pas en mode "playing" (cas √©trange?), juste s'assurer que l'UI est correcte
                    playPauseBtn.textContent = '‚ñ∂Ô∏è Lire';
                    stopBtn.disabled = true;
                    playPauseBtn.disabled = !currentStory;
                    if (currentStory) {
                         highlightPlayingStory(currentStory.id, false);
                         document.querySelector(`#story-list li[data-story-id="${currentStory.id}"]`)?.classList.add('selected');
                    }
                 }
             }

            function playPlayback() {
                if (!currentStory || TTSManager.isSpeaking()) return;

                initAudioContextIfNeeded(); // Important pour mobile

                console.log("Requesting TTS playback:", currentStory.name);
                const ttsStarted = TTSManager.speak(currentStory.text, handleTTSFinished);

                if (ttsStarted) {
                    isPlaying = true; // √âtat global de lecture activ√©
                    playPauseBtn.textContent = 'Reading...'; // Indiquer que √ßa lit
                    playPauseBtn.disabled = true; // D√©sactiver pendant la lecture (on utilise Stop)
                    stopBtn.disabled = false;
                    updateStatus(`Lecture : ${currentStory.name}${currentMusic ? ` (avec ${currentMusic.name})` : ''}`, true);
                    highlightPlayingStory(currentStory.id, true);

                    // Jouer la musique si s√©lectionn√©e
                    if (currentMusic) {
                        console.log("Playing music:", currentMusic.name);
                         musicAudio.play().catch(e => {
                             console.error("Error playing music:", e);
                             // Peut arriver si l'utilisateur n'a pas interagi
                             if (!audioContextResumed) {
                                 updateStatus(`Erreur musique. Cliquez/Touchez l'√©cran puis r√©essayez.`);
                             }
                         });
                    }
                } else {
                     // TTS n'a pas d√©marr√© (d√©j√† en cours, non support√©, etc.)
                     console.warn("TTS could not start.");
                     // Si l'√©chec est d√ª √† l'interaction, initAudioContextIfNeeded devrait d√©j√† afficher un message
                     if (TTSManager.isSupported()) { // N'affiche que si le TTS est cens√© marcher
                         updateStatus("Impossible de d√©marrer la lecture vocale pour le moment.");
                     }
                }
            }

            // Pause/Resume sont retir√©s car peu fiables pour TTS. On utilise Stop.
            // function pausePlayback() { ... }
            // function resumePlayback() { ... }

            function stopPlayback() {
                console.log("Stopping playback (TTS and Music)");
                TTSManager.cancel(); // Arr√™te la synth√®se vocale
                musicAudio.pause();
                musicAudio.currentTime = 0;

                isPlaying = false; // √âtat global
                isTTSReading = false; // √âtat TTS

                playPauseBtn.textContent = '‚ñ∂Ô∏è Lire';
                stopBtn.disabled = true; // On ne peut pas stopper si d√©j√† arr√™t√©
                playPauseBtn.disabled = !currentStory; // D√©sactiv√© si aucune histoire s√©lectionn√©e

                 if (currentStory) {
                     updateStatus(`Arr√™t√©. Pr√™t pour : ${currentStory.name}`, false);
                     highlightPlayingStory(currentStory.id, false);
                     // Garde 'selected'
                     document.querySelector(`#story-list li[data-story-id="${currentStory.id}"]`)?.classList.add('selected');
                 } else {
                     updateStatus('S√©lectionnez une histoire.', false);
                 }
            }

            function setMusicVolume(volume) {
                musicAudio.volume = volume;
                musicVolumeOutput.textContent = `${Math.round(volume * 100)}%`;
            }

            function updateStatus(message, isNowPlaying = false) {
                statusEl.textContent = message;
                statusEl.classList.toggle('playing', isNowPlaying);
            }

             function highlightPlayingStory(storyId, isNowPlaying) {
                 document.querySelectorAll('#story-list li').forEach(li => {
                     if (li.dataset.storyId === storyId) {
                         li.classList.toggle('playing', isNowPlaying);
                         // Si on arr√™te de jouer, mais que c'est toujours l'histoire s√©lectionn√©e, remettre 'selected'
                         if (!isNowPlaying && currentStory && currentStory.id === storyId) {
                            li.classList.add('selected');
                         } else {
                             // Si on commence √† jouer, enlever 'selected' car 'playing' prend le dessus
                             if (isNowPlaying) li.classList.remove('selected');
                         }
                     } else {
                         li.classList.remove('playing'); // Assurer qu'aucun autre n'est marqu√© comme jouant
                     }
                 });
            }

            // --- √âcouteurs d'√©v√©nements ---
            playPauseBtn.addEventListener('click', playPlayback); // Bouton unique pour d√©marrer
            stopBtn.addEventListener('click', stopPlayback);
            musicSelectEl.addEventListener('change', selectMusic);
            voiceSelectEl.addEventListener('change', () => {
                // Si on change de voix pendant la lecture, il faut arr√™ter et red√©marrer
                if (TTSManager.isSpeaking()) {
                    console.log("Voice changed during playback. Stopping and restarting.");
                    const currentText = currentStory?.text; // Sauver le texte
                    stopPlayback(); // Arr√™te tout
                    // Petit d√©lai pour √™tre s√ªr que tout est arr√™t√© avant de relancer
                    setTimeout(() => {
                        if (currentText && currentStory) { // V√©rifier si on a toujours une histoire s√©lectionn√©e
                             selectStory(currentStory); // Res√©lectionne pour UI
                             playPlayback(); // Relance avec la nouvelle voix
                        }
                    }, 200);
                }
            });

            musicVolumeSlider.addEventListener('input', (e) => setMusicVolume(e.target.value));

             // G√©rer les erreurs de chargement de la musique
             musicAudio.addEventListener('error', (e) => {
                 console.error('Error loading/playing music audio:', e);
                 updateStatus(`Erreur chargement musique: ${currentMusic?.name || 'inconnue'}.`);
                 musicAudio.pause();
                 musicAudio.src = "";
                 currentMusic = null;
                 musicSelectEl.value = ""; // R√©initialise le select
             });

            // --- Initialisation ---
            initAudioContextIfNeeded(); // Pr√©pare l'audio pour l'interaction
            TTSManager.init(); // Initialise la synth√®se vocale (qui peut peupler les voix de mani√®re asynchrone)
            populateStories();
            populateMusic();
            setMusicVolume(musicVolumeSlider.value); // Volume initial

            console.log("Conte de Poche (TTS) App Ready.");
        });
    </script>
</body>
</html>
